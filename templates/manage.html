<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card mt-5">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h1 class="mb-0">üè™ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
                            <a href="/" class="btn btn-outline-primary">
                                üè† ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å
                            </a>
                        </div>

                        <div class="add-form mb-4">
                            <div class="card">
                                <div class="card-body">
                                    <h3 class="card-title mb-3">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
                                    <form id="addForm" class="row g-3">
                                        <div class="col-md-5">
                                            <input type="text" id="category" class="form-control" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" required>
                                        </div>
                                        <div class="col-md-5">
                                            <input type="text" id="restaurant" class="form-control" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£" required>
                                        </div>
                                        <div class="col-md-2">
                                            <button type="submit" class="btn btn-success w-100">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <div class="restaurant-list">
                            <h3 class="mb-3">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h3>
                            {% for category, restaurants in categories.items() %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title text-primary">{{ category }}</h5>
                                    <div class="list-group">
                                        {% for restaurant in restaurants %}
                                        <div class="list-group-item d-flex justify-content-between align-items-center">
                                            {{ restaurant }}
                                            <button class="btn btn-danger btn-sm delete-btn" 
                                                    data-category="{{ category }}" 
                                                    data-restaurant="{{ restaurant }}">
                                                ‡∏•‡∏ö
                                            </button>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ô‡∏ö event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
        function attachDeleteListeners() {
            document.querySelectorAll('.delete-btn').forEach(button => {
                // ‡∏•‡∏ö event listener ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ã‡πâ‡∏≥
                button.replaceWith(button.cloneNode(true));
                
                // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡∏°‡πà
                document.querySelector(`[data-category="${button.dataset.category}"][data-restaurant="${button.dataset.restaurant}"]`)
                    .addEventListener('click', async () => {
                        if (!confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;

                        const category = button.dataset.category;
                        const restaurant = button.dataset.restaurant;

                        try {
                            const response = await fetch('/api/restaurant', {
                                method: 'DELETE',
                                body: new FormData([['category', category], ['restaurant', restaurant]])
                            });
                            const data = await response.json();
                            
                            if (data.error) {
                                alert(data.error);
                                return;
                            }
                            
                            // ‡∏•‡∏ö element ‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
                            const restaurantElement = button.closest('.list-group-item');
                            restaurantElement.remove();
                            
                            // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏•‡∏ö‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏Ç‡∏≠‡∏á‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏≠‡∏≠‡∏Å
                            const categoryCard = button.closest('.card');
                            if (categoryCard.querySelectorAll('.list-group-item').length === 0) {
                                categoryCard.remove();
                            }
                        } catch (error) {
                            console.error('Error:', error);
                            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
                        }
                    });
            });
        }

        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        attachDeleteListeners();

        document.getElementById('addForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const category = document.getElementById('category').value;
            const restaurant = document.getElementById('restaurant').value;

            try {
                const formData = new FormData();
                formData.append('category', category);
                formData.append('restaurant', restaurant);

                const response = await fetch('/api/restaurant', {
                    method: 'POST',
                    body: formData
                });
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                // ‡∏™‡∏£‡πâ‡∏≤‡∏á element ‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤
                let categoryCard = document.querySelector(`.card-title.text-primary:contains("${category}")`);
                
                if (!categoryCard) {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà
                    const newCategoryHtml = `
                        <div class="card mb-3">
                            <div class="card-body">
                                <h5 class="card-title text-primary">${category}</h5>
                                <div class="list-group">
                                </div>
                            </div>
                        </div>
                    `;
                    document.querySelector('.restaurant-list').insertAdjacentHTML('beforeend', newCategoryHtml);
                    categoryCard = document.querySelector(`.card-title.text-primary:contains("${category}")`);
                }

                // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                const newRestaurantHtml = `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        ${restaurant}
                        <button class="btn btn-danger btn-sm delete-btn" 
                                data-category="${category}" 
                                data-restaurant="${restaurant}">
                            ‡∏•‡∏ö
                        </button>
                    </div>
                `;
                categoryCard.closest('.card').querySelector('.list-group').insertAdjacentHTML('beforeend', newRestaurantHtml);

                // ‡πÅ‡∏ô‡∏ö event listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                attachDeleteListeners();

                // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
                document.getElementById('category').value = '';
                document.getElementById('restaurant').value = '';
            } catch (error) {
                console.error('Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£');
            }
        });

        // ‡πÄ‡∏û‡∏¥‡πà‡∏° polyfill ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö :contains selector
        jQuery.expr[':'].contains = function(a, i, m) {
            return jQuery(a).text().toUpperCase()
                .indexOf(m[3].toUpperCase()) >= 0;
        };
    </script>
</body>
</html> 